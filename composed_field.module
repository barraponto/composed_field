<?php
/**
 * @file
 * Defines composed field type.
 */

/**
 * Implements hook_field_info().
 */
function composed_field_field_info() {
  return array(
    // We name our field as the associative name of the array.
    'composed_field' => array(
      'label' => t('Composed field'),
      'description' => t('This field stores serialized array in the database.'),
      'default_widget' => 'composed_field_widget',
      'default_formatter' => 'composed_field_formatter',
    ),
  );
}

/**
 * Implements hook_field_widget_info().
 */
function composed_field_field_widget_info() {
  return array(
    'composed_field_widget' => array(
      'label' => t('Composed field'),
      'field types' => array('composed_field'),
      // 'settings' => array('rows' => 5),
    ),
  );
}

/**
 * Implements hook_field_formatter_info().
 */
function composed_field_field_formatter_info() {
  return array(
    // This formatter just displays the hex value in the color indicated.
    'composed_field_formatter' => array(
      'label' => t('Composed field'),
      'field types' => array('composed_field'),
    ),
  );
}

/**
 * Implements hook_field_is_empty().
 *
 * hook_field_is_emtpy() is where Drupal asks us if this field is empty.
 * Return TRUE if it does not contain data, FALSE if it does. This lets
 * the form API flag an error when required fields are empty.
 */
function composed_field_field_is_empty($item, $field) {
  //return empty($item['rgb']);
  
  // TODO:
  return FALSE;
  
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Updates the widget form on each Ajax callback.
 */
function composed_field_form_field_ui_field_edit_form_alter(&$form, &$form_state, $form_id){
  // Work only on field of type composed_field and when the form has been
  // submitted.
  if ($form['#field']['type'] == 'composed_field' &&
      isset($form_state['values']['instance']['widget']['settings'])) {

    $form_widget = $form['instance']['widget']['settings'];
    $widget_form_field_values = $form_state['values']['instance']['widget']['settings'];

    // Build the form elements in each tab.
    $form_widget['#composed_field']['vertical_tab_settings'] = array(
      'subfield_start_from' => 1,
      'number_of_subfields' => $widget_form_field_values['number_of_subfields'],
      'widget_form_element_disabled' => FALSE,
      'default_value' => '',
      'subfield_element_attribute_enabled' => FALSE,
      'widget_form_field_values_are_set' => TRUE,
    );

    _composed_field_build_form_controls_in_vertical_tab($form_widget, $widget_form_field_values);
      
    // Return the updated form.
    $form['instance']['widget']['settings'] = $form_widget;
  }
}


/**
 * Implements hook_field_widget_settings_form().
 */
function composed_field_field_widget_settings_form($field, $instance) {

  $widget_form_field_values = $instance['widget']['settings'];
  // Assume this field is being created.
  $widget_form_field_values_are_set = FALSE;
  // All the elements start off disabled.
  $widget_form_element_disabled = TRUE;

  $number_of_subfields_title = t('Number of subfields');

  // Assume there is no value set for number_of_subfields as yet.
  $default_value = t('You must enter a value into !number_of_subfields', array('!number_of_subfields' => $number_of_subfields_title));

  //$widget_form_field_values['number_of_subfields'] = 1;

  if (isset($widget_form_field_values['number_of_subfields'])) {
    // This is not a field creationg.
    $number_of_subfields = $widget_form_field_values['number_of_subfields'];
    $widget_form_field_values_are_set = TRUE;
    // All the elements start off enabled.
    $widget_form_element_disabled = FALSE;
    $default_value = '';
  }
  else {
    $widget_form_field_values['number_of_subfields'] = '';
    $number_of_subfields = 1;
  }

  $form['inline'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display as inline element'),
    '#default_value' => (empty($widget_form_field_values['inline'])) ? FALSE : $widget_form_field_values['inline'],
  );

  // This element determines how many components our field will have.
  $form['number_of_subfields'] = array(
    '#type' => 'textfield',
    '#title' => $number_of_subfields_title,
    '#description' => t('Enter a numeric value and hit the tab key after that.') . '<br />' .
      t('This value determines how many subfields this field will have.'),
    '#default_value' => $widget_form_field_values['number_of_subfields'],
    '#maxlength' => 2,
    '#size' => 2,
    '#element_validate' => array('element_validate_integer_positive'),
    '#required' => TRUE,
    '#ajax' => array(
      'callback' => '_composed_field_number_of_fields_ajax_callback',
    ),
  );

  $form['composed_field'] = array(
    '#type' => 'vertical_tabs',
    '#prefix' => "<div id='composed_field_tabs_ajax_wrapper'>",
    '#suffix' => '</div>',
  );

  // Build the form elements in each tab.
  $form['#composed_field'] = array(
    'vertical_tab_settings' => array(
      'subfield_start_from' => 1,
      'number_of_subfields' => $number_of_subfields,
      'widget_form_element_disabled' => $widget_form_element_disabled,
      'default_value' => $default_value,
      'subfield_element_attribute_enabled' => FALSE,
      'widget_form_field_values_are_set' => $widget_form_field_values_are_set,
    ),
    'form_controls' => _composed_field_form_controls_api(),
  );
  

  _composed_field_build_form_controls_in_vertical_tab($form, $widget_form_field_values);
  
  //'#default_value' => list_allowed_values_string(empty($settings[$subfield]['select']['allowed_values']) ? array() : $settings[$subfield]['select']['allowed_values']),

  return $form;
}

  /*return array(
    '#type' => 'ajax',
    '#commands' => array(
      ajax_command_invoke('#test-ajax_wrapper input', 'attr', array('disabled','disabled')),
      ajax_command_invoke('#test-ajax_wrapper .form-item', 'addClass', array('form-disabled')),
    ),
  );*/


/**
 * AJAX callback from number_of_fields widget form element.
 */
function _composed_field_number_of_fields_ajax_callback($form, $form_state) {
  $form_widget = $form['instance']['widget']['settings'];

  return array(
    '#type' => 'ajax',
    '#commands' => array(
      ajax_command_replace("#composed_field_tabs_ajax_wrapper", render($form_widget['composed_field'])),
    ),
  );
}

/**
 * AJAX callback from type widget form element.
 */
function _composed_field_type_ajax_callback($form, $form_state) {
  $submmited_values = $form_state['values']['instance']['widget']['settings'];
  //$triggering_element = $form_state['triggering_element'];
  
  // The reason for using the array key 5 is because of this:
  // [0] => instance
  // [1] => widget
  // [2] => settings
  // [3] => composed_field
  // [4] => _#type
  // [5] => < THE SUBFIELD NUMBER >
  // [6] => value.
  //$subfield_number = $triggering_element['#parents'][5];
  //$subfields_total = $submmited_values['number_of_subfields'];

  $all_subfield_type_values_are_set = _composed_field_all_type_values_are_set($submmited_values['composed_field']['_#type']);

  // We only want any action to be taken after all values in the #type tab
  // are filled up.  
  if ($all_subfield_type_values_are_set) {

  
    // Some form control attributes are not needed depending on the
    // form control type selected on each subfield.
  


  }
  else{
    return;
  }
}

/**
 * Check if all values in the #type tab have been fullfilled.
 *
 * @param Array $type_submitted_values
 *   The submitted values of the #type tab form.
 *
 * @return Boolean
 *   Whether or not there is still any subfield value for #type left to be
 *   selected.
 */
function _composed_field_all_type_values_are_set($type_submitted_values) {
  $all_subfield_type_values_are_set = TRUE;

  foreach($type_submitted_values as $subfield => $form_values) {
    if (isset($form_values['value']) &&
        empty($form_values['value'])) {
      $all_subfield_type_values_are_set = FALSE;
      // Having at least one subfield value for #type yet to be selected is
      // enough to set FALSE for $widget_form_field_values_are_set so we stop
      // the looping.
      break;
    }
  }

  return $all_subfield_type_values_are_set;
}


/**
 * AJAX callback.
 */
function _composed_field_enable_subfield_attribute_ajax_callback($form, $form_state) {
  $widget_form_submmited_values = $form_state['values']['instance']['widget']['settings'];
  // #parents Array:
  // [0] => instance
  // [1] => widget
  // [2] => settings
  // [3] => composed_field
  // [4] => <$tab_name>
  // [5] => <$subfield>
  // [6] => value.
  $tab_name = $form_state['triggering_element']['#parents'][4];
  $subfield = $form_state['triggering_element']['#parents'][5];
  $subfield_element_attribute_enabled_value = $widget_form_submmited_values['composed_field'][$tab_name][$subfield]['enabled'];

  $widget_form_element = $form['instance']['widget']['settings']['composed_field'][$tab_name][$subfield]['value'];

  $widget_form_element['#disabled'] = TRUE;
  if ($subfield_element_attribute_enabled_value) {
    //$widget_form_element['#disabled'] = FALSE;
  }

  //$form['instance']['widget']['settings']['number_of_subfields']['#disabled'] = TRUE;
  $form['instance']['widget']['settings']['composed_field']['_#title'][2]['value']['#disabled'] = FALSE;
  
    /*$file = "/tmp/test.txt";
    // Open the file to get existing content
    // $current = file_get_contents($file);
    // Append a new person to the file
    $current = print_r($form, TRUE);
    // Write the contents back to the file
    file_put_contents($file, $current);*/


 //return $form['instance']['widget']['settings']['composed_field']['_#title'][1]['value'];
  return array(
    '#type' => 'ajax',
    '#commands' => array(
      ajax_command_replace("#composed_field_-2-value-ajax_wrapper", render($form['instance']['widget']['settings']['composed_field']['_#title'][1]['value'])),
    ),
  );
  
  /*return array(
    '#type' => 'ajax',
    '#commands' => array(
      ajax_command_invoke('#composed_field_-1-value-ajax_wrapper input', 'attr', array('disabled','disabled')),
      ajax_command_invoke('#composed_field_-1-value-ajax_wrapper .form-item', 'addClass', array('form-disabled')),
    ),
  );*/
  
}

/**
 * Implements hook_field_widget_form().
 */
function composed_field_field_widget_form(&$form, &$form_state, $field, $instance, $langcode, $items, $delta, $element) {



  return $element;
}


/**
 * Form Control Attributes.
 *
 * @see http://api.drupal.org/api/drupal/developer!topics!forms_api_reference.html/7
 *
 * @return Array
 *   Map of the form controls api.
 */
function _composed_field_form_controls_api() {
  include_once('includes/composed_field.form.controls.inc');
  return $form_controls;
}


/**
 * Builds the vertical tabs.
 *
 * @param Array $form
 *   The widget settings form.
 * @param Array $widget_form_field_values
 *   It is either the form saved values or the form submitted values.
 */
function _composed_field_build_form_controls_in_vertical_tab(&$form, $widget_form_field_values) {

  /*$file = "/tmp/test.txt";
  // Open the file to get existing content
  $current = file_get_contents($file);
  // Append a new person to the file
  $current .= print_r($form['#form_controls'], TRUE);
  // Write the contents back to the file
  file_put_contents($file, $current);*/

  foreach($form['#composed_field']['form_controls'] as $attribute_name => $form_control_structure) {

    // The Form API wont allow form element names starting with #, so we add a _
    // before the form control attribute name.
    $tab_name = str_replace('#', '', $attribute_name);

    // Set a vertical tab for each form control attribute.
    $form['composed_field'][$tab_name] = array(
      '#title' => $attribute_name,
      '#type' => 'fieldset',
      '#description' => t('See !form_controls for more details.',
        array('!form_controls' => l(t('Form Controls'),
        'http://api.drupal.org/api/drupal/developer!topics!forms_api_reference.html/7',
        array('attributes' => array('target' => '_blank'))))
      ),
      '#attributes' => array('id' => array("composed_field_tab_$tab_name-ajax_wrapper")),
      //'#prefix' => "<span id='composed_field_tab_$tab_name-ajax_wrapper'>",
      //'#suffix' => '</span>',
    );
   
    $form['#composed_field']['vertical_tab_settings']['attribute_name'] = $attribute_name;
    $form['#composed_field']['vertical_tab_settings']['tab_name'] = $tab_name;
    // Build the tab elements.
    _composed_field_build_vertical_tab_elements($form, $widget_form_field_values, $form_control_structure);
  }
}


/**
 * Populates each vertical tab with their form elements.
 * 
 * @param Array $form
 *   The widget settings form.
 * @param Array $widget_form_field_values
 *   It is either the form saved values or the form submitted values.
 * @param Array $form_control_structure
 *   The form element's structure.
 */
function _composed_field_build_vertical_tab_elements(&$form, $widget_form_field_values, $form_control_structure) {
  
  /*$file = "/tmp/test.txt";
  // Open the file to get existing content
  $current = file_get_contents($file);
  // Append a new person to the file
  $current .= "$caller" . print_r($form['#composed_field']['vertical_tab_settings'], TRUE);
  // Write the contents back to the file
  file_put_contents($file, $current);*/

  foreach ($form['#composed_field']['vertical_tab_settings'] as $setting_name => $setting_value) {
    ${$setting_name} = $setting_value;
  }

  // Create as many form elements in each tab as there are subfields.
  for ($subfield = $subfield_start_from;
       $subfield <= $number_of_subfields;
       $subfield++) {

    $form['composed_field'][$tab_name][$subfield] = array(
      '#type' => 'fieldset',
    );
 
    foreach($form_control_structure['widget_form'] as $form_element => $form_element_properties) {
      // Inicial state of all form elements.
      $form_element_properties['#disabled'] = $widget_form_element_disabled;

      if ($attribute_name == '#type') {
        if ($widget_form_element_disabled) {
          // The user hasn't entered a value into Number of subfields as yet.
          $form_element_properties['#options'] = array('' => $default_value);
        }
      }
      else {
        if ($widget_form_field_values_are_set) {
          $subfield_element_attribute_enabled = $widget_form_field_values['composed_field'][$tab_name][$subfield]['enabled'];
        }
        $form['composed_field'][$tab_name][$subfield]['enabled'] = array(
          '#type' => 'checkbox',
          '#title' => t('Enable !attribute attribute for Subfield !subfield.', array('!attribute' => $attribute_name, '!subfield' => $subfield)),
          '#disabled' => $widget_form_element_disabled,
          '#default_value' => $subfield_element_attribute_enabled,
          '#ajax' => array(
            'callback' => '_composed_field_enable_subfield_attribute_ajax_callback',
          ),
        );
      }

      // Get default value from $instance['widget']['settings'].
      $form_element_properties['#default_value'] = $default_value;
      if ($widget_form_field_values_are_set) {
        $form_element_properties['#default_value'] = $default_value = $widget_form_field_values['composed_field'][$tab_name][$subfield][$form_element];
      }

      // Check if this is the element that holds the form control property
      // value.
      if ($form_element == 'value') {
        // Set title.
        $title = (empty($form_element_properties['#title'])) ? '' : $form_element_properties['#title'];
        $form_element_properties['#title'] = $title . t('Subfield !subfield', array('!subfield' => $subfield));
        
        if (!$subfield_element_attribute_enabled && $attribute_name != '#type') {
          $form_element_properties['#disabled'] = TRUE; 
        }
      }

      // Set the ajax wrapper.
      $form_element_properties += array(
        '#prefix' => "<div id='composed_field_-$subfield-$form_element-ajax_wrapper'>",
        '#suffix' => '</div>',
      );

      $form['composed_field'][$tab_name][$subfield][$form_element] = $form_element_properties;
    }
  }
}


